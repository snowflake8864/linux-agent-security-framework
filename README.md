# Linux Agent Security Framework

åŸºäº eBPF æŠ€æœ¯å®ç°çš„ Linux å®‰å…¨é˜²æŠ¤æ¡†æ¶ï¼Œé›†æˆäº†é«˜æ€§èƒ½ç½‘ç»œè½¬å‘ï¼ˆNATï¼‰ã€å†…æ ¸çº§æ–‡ä»¶è®¿é—®æ§åˆ¶ï¼ˆLSMï¼‰å’Œè¿›ç¨‹ç›‘æ§ã€‚

è¯¥é¡¹ç›®é€šè¿‡ XDP å’Œ TC é’©å­åœ¨å†…æ ¸ç½‘ç»œæ—©æœŸå¤„ç†æ•°æ®åŒ…ï¼Œå¹¶é€šè¿‡ BPF LSM å®ç°å¯¹ç³»ç»Ÿè°ƒç”¨çš„å®æ—¶æ‹¦æˆªï¼Œä¸º Linux æœåŠ¡å™¨æä¾›è½»é‡çº§ã€ä½å»¶è¿Ÿçš„å®‰å…¨ä¿éšœã€‚

---

## ğŸ“‹ ç³»ç»Ÿè¦æ±‚ä¸ç¯å¢ƒé…ç½®

åœ¨è¿è¡Œæœ¬é¡¹ç›®å‰ï¼Œè¯·åŠ¡å¿…æ£€æŸ¥å¹¶é…ç½®æ‚¨çš„å†…æ ¸ç¯å¢ƒï¼Œå¦åˆ™ LSM ç­‰æ ¸å¿ƒåŠŸèƒ½å°†æ— æ³•å¯åŠ¨ã€‚

### 1. å†…æ ¸ç‰ˆæœ¬
- **æœ€ä½è¦æ±‚**: Linux Kernel 5.8
- **æ¨èç‰ˆæœ¬**: Linux Kernel 5.10+ (å¯¹ BTF å’Œ LSM é’©å­çš„æ”¯æŒæ›´å®Œå–„)

### 2. å†…æ ¸ç¼–è¯‘é€‰é¡¹ (Kconfig)
ç¡®ä¿å†…æ ¸å¼€å¯äº†ä»¥ä¸‹åŠŸèƒ½ï¼ˆå¤§å¤šæ•°ç°ä»£å‘è¡Œç‰ˆå¦‚ Ubuntu 20.04+ å·²å¼€å¯ï¼‰ï¼š
- `CONFIG_BPF=y`
- `CONFIG_BPF_LSM=y` (ç”¨äºæ–‡ä»¶/è¿›ç¨‹é˜²æŠ¤)
- `CONFIG_DEBUG_INFO_BTF=y` (å…³é”®ï¼šæ”¯æŒ BPF CO-RE ç‰¹æ€§ï¼Œå®ç°ä¸€æ¬¡ç¼–è¯‘åˆ°å¤„è¿è¡Œ)
- `CONFIG_BPF_JIT=y`

**æ£€æŸ¥å‘½ä»¤**:
```bash
grep -E "CONFIG_BPF_LSM|CONFIG_DEBUG_INFO_BTF" /boot/config-$(uname -r)
```

### 3. GRUB é…ç½® (å¯ç”¨ BPF LSM)
ç”±äºå®‰å…¨åŸå› ï¼Œå¾ˆå¤šç³»ç»Ÿé»˜è®¤ç¦ç”¨äº† BPF LSMã€‚ä½ éœ€è¦é€šè¿‡ GRUB æ‰‹åŠ¨å¼€å¯ï¼š

1. ç¼–è¾‘ `/etc/default/grub`ã€‚
2. åœ¨ `GRUB_CMDLINE_LINUX_DEFAULT` å‚æ•°ä¸­åŠ å…¥ `lsm=lockdown,yama,apparmor,bpf`ï¼ˆå…³é”®æ˜¯å¿…é¡»åŒ…å« `bpf`ï¼‰ã€‚
   - ä¾‹å¦‚ï¼š`GRUB_CMDLINE_LINUX_DEFAULT="quiet splash lsm=lockdown,yama,apparmor,bpf"`
3. æ›´æ–° GRUB é…ç½®ï¼š`sudo update-grub`ã€‚
4. **é‡å¯ç³»ç»Ÿ**ã€‚
5. é‡å¯åéªŒè¯ï¼š`cat /sys/kernel/security/lsm`ã€‚è¾“å‡ºä¸­è‹¥åŒ…å« `bpf` åˆ™è¡¨ç¤ºå¯ç”¨æˆåŠŸã€‚

---

## ğŸš€ ç¼–è¯‘ä¸å®‰è£…

### 1. å®‰è£…ç¼–è¯‘ä¾èµ– (Ubuntu/Debian)
```bash
sudo apt update
sudo apt install -y build-essential clang llvm libelf-dev libbpf-dev pkg-config zig
# å®‰è£… Rust åŠç›¸å…³ç»„ä»¶
rustup component add rust-src
cargo install cargo-zigbuild
```

### 2. ç¼–è¯‘é¡¹ç›®
```bash
# 1. ç¼–è¯‘å†…æ ¸æ€ eBPF ä»£ç  (ç”Ÿæˆçš„ .o æ–‡ä»¶åœ¨ bpf/ ç›®å½•)
cargo run -p xtask -- build-bpf

# 2. ç¼–è¯‘ç”¨æˆ·æ€ç¨‹åº (æ¨è musl é™æ€ç¼–è¯‘)
cargo zigbuild --release --target x86_64-unknown-linux-musl
```

---

## ğŸ›  åŠŸèƒ½æ¨¡å—è¯¦è§£

### 1. ç½‘ç»œè½¬å‘ (NAT & Redirect)
- **è¿œç¨‹è½¬å‘**: å°†æœ¬æœºç›‘å¬ç«¯å£çš„æµé‡è½¬å‘åˆ°å†…ç½‘å…¶ä»–æœåŠ¡å™¨ã€‚æ”¯æŒè‡ªåŠ¨ SNAT/DNATï¼Œè§£å†³å›åŒ…è·¯ç”±é—®é¢˜ã€‚
- **æœ¬åœ°é‡å®šå‘**: å°†å¤–éƒ¨è®¿é—®é‡å®šå‘åˆ°æœ¬æœºçš„å¦ä¸€ä¸ªç«¯å£ã€‚ä¾‹å¦‚ï¼šå¤–éƒ¨è®¿é—® 5555 ç«¯å£ï¼Œå†…æ ¸è‡ªåŠ¨è½¬åˆ°æœ¬åœ°çš„ 22 (SSH)ã€‚
- **ACL æ§åˆ¶**: æ”¯æŒåŸºäº CIDR (ç½‘æ®µ) çš„æº IP ç™½åå•è¿‡æ»¤ã€‚

### 2. æ–‡ä»¶å®‰å…¨ç®¡æ§ (LSM File Security)
- **å¤šç»´åº¦å®¡è®¡**: ç›‘æ§æ–‡ä»¶çš„ `Read`, `Write`, `Create`, `Delete` è¡Œä¸ºã€‚
- **å¼ºåˆ¶é˜»æ–­**: åœ¨å†…æ ¸å±‚æ‹¦æˆªéæ³•æ“ä½œã€‚å³ä½¿æ˜¯ root ç”¨æˆ·ï¼Œåœ¨ `Protect` æ¨¡å¼ä¸‹ä¹Ÿæ— æ³•æ“ä½œå—ä¿æŠ¤çš„æ–‡ä»¶ã€‚

### 3. è¿›ç¨‹å®‰å…¨ (Process Control)
- **å¯åŠ¨æ‹¦æˆª**: é˜»æ–­éæ³•çš„äºŒè¿›åˆ¶æ–‡ä»¶æ‰§è¡Œã€‚
- **comm åŒ¹é…**: åŸºäºè¿›ç¨‹åç§°å®ç°ç®€å•çš„ç™½åå•/é»‘åå•ç®¡æ§ã€‚

---

## âš™ï¸ é…ç½®æ–‡ä»¶å…¨è§£æ (`unified_config.json`)

```json
{
  "file_mode": "Protect",     // å…¨å±€æ–‡ä»¶æ¨¡å¼: Monitor (ä»…è®°å½•) / Protect (é˜»æ–­)
  "process_mode": "Protect",  // å…¨å±€è¿›ç¨‹æ¨¡å¼: Monitor / Protect
  "network": {
    "enabled": true,          // æ˜¯å¦å¯ç”¨ç½‘ç»œåŠŸèƒ½
    "engine": "xdp",          // å¼•æ“: xdp (æè‡´æ€§èƒ½) / tc (æ›´å¥½çš„å…¼å®¹æ€§)
    "interface": "enp2s0",    // å¿…é¡»æŒ‡å®šæ­£ç¡®çš„ç½‘å¡å
    "block_ports": [23, 445], // å…¨å±€é™é»˜ä¸¢å¼ƒè¿™äº›ç«¯å£çš„åŒ…
    
    "forward_rules": [        // è¿œç¨‹è½¬å‘è§„åˆ™
      {
        "listen_port": [1000, "2000-2010"], // æ”¯æŒå•ä¸ªç«¯å£æˆ–èŒƒå›´
        "target_host": "192.168.3.4",       // è½¬å‘ç›®æ ‡ IP
        "target_port": 22,                  // ç›®æ ‡ç«¯å£
        "protocol": "tcp",                  // åè®®ç±»å‹: tcp / udp
        "allowed_sources": ["10.0.0.0/8"]   // æº IP é™åˆ¶
      }
    ],
    
    "local_forward_rules": [  // æœ¬åœ°é‡å®šå‘è§„åˆ™
      {
        "listen_port": [5555],
        "target_port": 22,
        "protocol": "tcp",
        "allowed_sources": ["0.0.0.0/0"]
      }
    ]
  },
  
  "file_rules": [             // æ–‡ä»¶ç›‘æ§ç»†åˆ™ (è·¯å¾„åŒ¹é…)
    {
      "path_prefix": "/etc/shadow",
      "operations": ["Read", "Write"],
      "action": "Deny"
    }
  ],
  
  "process_rules": [          // è¿›ç¨‹ç›‘æ§ç»†åˆ™ (åç§°åŒ¹é…)
    {
      "comm": "nc",
      "action": "Deny"
    }
  ]
}
```

## ğŸ“‚ é¡¹ç›®ç»“æ„è¯´æ˜

æœ¬æ¡†æ¶é‡‡ç”¨æ¨¡å—åŒ–è®¾è®¡ï¼Œæ¸…æ™°åˆ’åˆ†äº†å†…æ ¸æ€æ¢é’ˆã€ç”¨æˆ·æ€ç®¡ç†ç¨‹åºåŠå…±äº«åº“ã€‚

### 1. æ ¸å¿ƒç›®å½•
- **`ebpf-probes/`**: eBPF å†…æ ¸æ€æ ¸å¿ƒã€‚
    - `bpf/`: åŒ…å«æ‰€æœ‰ C ç¼–å†™çš„ `.bpf.c` æºç ï¼ˆå¦‚ `unified_agent.bpf.c`ï¼‰åŠå…¶ç¼–è¯‘ç”Ÿæˆçš„ `.o` å¯¹è±¡ã€‚
    - `src/`: æ¢é’ˆçš„ç”¨æˆ·æ€ç®¡ç†é€»è¾‘ï¼Œè´Ÿè´£åŠ è½½ã€æŒ‚è½½åŠä¸å†…æ ¸äº¤äº’ã€‚
- **`ebpf-common/`**: è·¨ç•Œå…±äº«åº“ã€‚
    - å®šä¹‰äº†å†…æ ¸æ€ä¸ç”¨æˆ·æ€é€šç”¨çš„ç»“æ„ä½“ï¼ˆEventã€Ruleã€PacketInfo ç­‰ï¼‰ï¼Œç¡®ä¿æ•°æ®åœ¨ C å’Œ Rust ä¹‹é—´æ— ç¼ä¼ é€’ã€‚
- **`apps/`**: ç”¨æˆ·æ€åŠŸèƒ½å®ç°ã€‚
    - `unified-agent/`: **æ¨èä½¿ç”¨**ã€‚é›†æˆäº†ç½‘ç»œè½¬å‘ã€LSM é˜²æŠ¤ç­‰å…¨åŠŸèƒ½çš„ç»Ÿä¸€ä»£ç†è§£æå™¨ã€‚
    - `forward/`: ä¸“æ³¨äºé«˜æ€§èƒ½è¿œç¨‹ç«¯å£è½¬å‘çš„ç‹¬ç«‹å·¥å…·ã€‚
    - `demo/`: ç”¨äºå¿«é€ŸéªŒè¯ LSM æ–‡ä»¶/è¿›ç¨‹ç›‘æ§èƒ½åŠ›çš„æ¼”ç¤ºåº”ç”¨ã€‚
- **`xtask/`**: è‡ªåŠ¨åŒ–æ„å»ºå·¥å…·ã€‚
    - å°è£…äº†å¤æ‚çš„ `clang` å’Œ `llvm` å‘½ä»¤ï¼Œé€šè¿‡ `cargo run -p xtask -- build-bpf` å³å¯ä¸€é”®ç¼–è¯‘æ‰€æœ‰å†…æ ¸æ¢é’ˆã€‚

### 2. å…¶ä»–æ¨¡å—
- **`ebpf-framework/`**: å°è£…äº†åº•å±‚ eBPF æ“ä½œçš„é€šç”¨æ¡†æ¶é€»è¾‘ã€‚
- **`bpf/`**: (æ ¹ç›®å½•ä¸‹) å­˜æ”¾ç¼–è¯‘å¥½çš„ eBPF å­—èŠ‚ç ï¼Œä¾›ç¨‹åºè¿è¡Œæ—¶åŠ è½½ã€‚

---

## ğŸ§ª æµ‹è¯•ä¸éªŒè¯

### 1. ç½‘ç»œè½¬å‘æµ‹è¯•
1. ä¿®æ”¹é…ç½®ï¼šè®¾ç½®æœ¬åœ°è½¬å‘ `5555 -> 22`ã€‚
2. å¯åŠ¨ä»£ç†ï¼š`sudo ./target/x86_64-unknown-linux-musl/release/unified-agent --config config.json --interface eth0`
3. è¿æ¥æµ‹è¯•ï¼š`ssh -p 5555 user@127.0.0.1`ã€‚
4. è§‚å¯Ÿå†…æ ¸æ—¥å¿—ï¼ˆå¼€å¯å¦ä¸€ä¸ªç»ˆç«¯ï¼‰ï¼š
   ```bash
   sudo cat /sys/kernel/debug/tracing/trace_pipe
   ```
   ä½ åº”è¯¥èƒ½çœ‹åˆ° `[XDP] Forward` å’Œ `[TC] Reverse NAT` çš„ç›¸å…³è¾“å‡ºã€‚

### 2. æ–‡ä»¶ä¿æŠ¤æµ‹è¯•
1. åœ¨ `file_rules` ä¸­æ·»åŠ å¯¹ `/tmp/test.txt` çš„ `Deny` è§„åˆ™ã€‚
2. å°è¯•æ“ä½œè¯¥æ–‡ä»¶ï¼š`touch /tmp/test.txt` æˆ– `rm /tmp/test.txt`ã€‚
3. é¢„æœŸç»“æœï¼šç³»ç»ŸæŠ¥é”™ `Operation not permitted`ã€‚

---

## ğŸ“‚ å¸¸è§é—®é¢˜ (FAQ)

1. **è½¬å‘ä¸é€šï¼Ÿ**
   - æ£€æŸ¥ `sysctl net.ipv4.ip_forward` æ˜¯å¦ä¸º 1ã€‚
   - ç¡®è®¤ `--interface` åé¢æ¥çš„æ˜¯æ´»è·ƒçš„ç½‘å¡åï¼ˆç”¨ `ip link` æŸ¥çœ‹ï¼‰ã€‚
2. **LSM è§„åˆ™æ²¡ç”Ÿæ•ˆï¼Ÿ**
   - æ£€æŸ¥å†…æ ¸ç‰ˆæœ¬æ˜¯å¦æ»¡è¶³ 5.8+ã€‚
   - æ£€æŸ¥ `cat /sys/kernel/security/lsm` ç¡®è®¤ `bpf` æ˜¯å¦åœ¨è¾“å‡ºåˆ—è¡¨ä¸­ã€‚
3. **ç¼–è¯‘æŠ¥é”™ï¼Ÿ**
   - ç¡®ä¿å®‰è£…äº† `libbpf-dev` å’Œ `clang`ï¼Œä¸”å·²ç»æ‰§è¡Œäº† `build-bpf` ä»»åŠ¡ã€‚

